---
#
# XXX - Need to do this as said user
# XXX - Probably not necessary to create user
# XXX - local_action to run script?
#
#	Create ssh user on jumphost. Note that the MCCI port-mapping
# numbering scheme is not really handled here, so this will
# usually be done by a separate script.
#
- name: "Set up {{ ssh_tunnel_gateway_user_on_jumphost }} user"
  user:
    name: "{{ ssh_tunnel_gateway_user_on_jumphost }}"
    append: yes
    shell: /bin/bash
    password: "*"
  tags: users

- name: Create {{ ssh_tunnel_gateway_user_on_jumphost }}  .ssh dir
  file:
    dest: "~{{ ssh_tunnel_gateway_user_on_jumphost }}/.ssh"
    state: directory
    mode: "0700"
    owner: "{{ ssh_tunnel_gateway_user_on_jumphost }}"
    group: "{{ ssh_tunnel_gateway_user_on_jumphost }}"
  tags: users

- name: "Install {{ ssh_tunnel_gateway_user_on_jumphost }} authorized keys"
  authorized_key:
    user: "{{ ssh_tunnel_gateway_user_on_jumphost }}"
    state: present
    key: '{{ item }}'
  with_items:
    - "{{ authorized_keys }}"
    - "{% for lora_gw in groups['conduits'] %}{% if 'ansible_ssh_host_key_rsa_public' in hostvars[lora_gw] %}ssh-rsa {{ hostvars[lora_gw]['ansible_ssh_host_key_rsa_public'] }} {{ hostvars[lora_gw]['ansible_hostname'] }}{% endif %}{% endfor %}"
  tags: users

- name: Only allow gateway ports from localhost
  lineinfile: dest=/etc/ssh/sshd_config
    regexp="^GatewayPorts"
    line="GatewayPorts no"
    state=present
  notify: Restart ssh
  tags: sshd

# tasks file for sshhost
