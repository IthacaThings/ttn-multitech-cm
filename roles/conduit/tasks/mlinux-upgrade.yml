---
#
# Check mLinux version
#

- name: mlinux-upgrade | Read md5sum.txt
  delegate_to: 127.0.0.1
  ansible.builtin.uri:
    url: "{{ mlinux_url }}/md5sum.txt"
    return_content: true
    timeout: 120
  ignore_errors: true
  register: checksum_data

- name: mlinux-upgrade | Read md5sums.txt
  delegate_to: 127.0.0.1
  ansible.builtin.uri:
    url: "{{ mlinux_url }}/md5sums.txt"
    return_content: true
    timeout: 120
  ignore_errors: true
  register: checksum_data
  when: checksum_data is not succeeded

- name: mlinux-upgrade | Verify that we have a checksum
  ansible.builtin.fail:
    msg: "Unable to find checksum file at: {{ mlinux_url }} | {{ checksum_data.msg }}"
  when: checksum_data is not succeeded

- name: mlinux-upgrade | Extract checksum from file
  ansible.builtin.set_fact:
    mlinux_upgrade_expected_md5: "{{ (checksum_data.content | regex_search('^([a-z0-9]{32})\\s+' ~ mlinux_upgrade_bin ~ '\\b', multiline=True)).split()[0] }}"

- name: mlinux-upgrade | Check if {{ mlinux_upgrade_bin }}_{{ mlinux_version }} is downloaded
  delegate_to: 127.0.0.1
  ansible.builtin.stat:
    checksum_algorithm: md5
    path: "{{ role_path }}/files/{{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
  register: mlinux_upgrade_stat

- name: mlinux-upgrade | Remove bad copy of {{ mlinux_upgrade_bin }}_{{ mlinux_version }}
  delegate_to: 127.0.0.1
  ansible.builtin.file:
    name: "{{ role_path }}/files/{{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
    state: absent
  when:
    - mlinux_upgrade_stat.stat.exists and mlinux_upgrade_stat.stat.checksum != mlinux_upgrade_expected_md5

- name: mlinux-upgrade | Download {{ mlinux_upgrade_bin }}_{{ mlinux_version }}
  delegate_to: 127.0.0.1
  ansible.builtin.get_url:
    url: "{{ mlinux_url }}/{{ mlinux_upgrade_bin }}"
    dest: "{{ role_path }}/files/{{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
    timeout: 14400
    checksum: "md5:{{ mlinux_upgrade_expected_md5 }}"
  when:
    - not mlinux_upgrade_stat.stat.exists or mlinux_upgrade_stat.stat.checksum != mlinux_upgrade_expected_md5

- name: mlinux-upgrade | Validate {{ mlinux_upgrade_bin }}_{{ mlinux_version }}
  delegate_to: 127.0.0.1
  ansible.builtin.command: "{{ role_path }}/files/mlinux-firmware-upgrade -h {{ conduit_type }} -n {{ role_path }}/files/{{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
  changed_when: true

- name: mlinux-upgrade | Unmonitor space usage on /var/volatile
  ansible.builtin.command: "monit unmonitor volatile"
  notify: monit monitor volatile
  changed_when: true
  ignore_errors: true

- name: mlinux-upgrade | Remove some temp files from a failed upgrade
  ansible.builtin.file:
    name: "{{ item }}"
    state: absent
    force: true
  loop:
    - /var/volatile/do_flash_upgrade
    - /var/volatile/flash-upgrade

- name: mlinux-upgrade | Copy {{ mlinux_upgrade_bin }}_{{ mlinux_version }} to {{ hostname }}
  ansible.builtin.copy:
    dest: /var/volatile/{{ mlinux_upgrade_bin }}_{{ mlinux_version }}
    src: "{{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
    mode: "0600"
    owner: root
    group: root
    unsafe_writes: true

- name: mlinux-upgrade | Copy over setup script
  ansible.builtin.template:
    src: mlinux_setup.j2
    dest: /var/config/mlinux_setup
    mode: "0755"
    owner: root
    group: root
  when: ansible_local.opkg.preserve is not defined

  # Only copy mlinux-firmware-upgrade if it does not exist
  # Our copy has -n to validate an image, but it is old
  # the new version does not support -n but supports newer hardware
- name: mlinux-upgrade | Copy over mlinux-firmware-upgrade script
  ansible.builtin.copy:
    dest: "/usr/sbin/mlinux-firmware-upgrade"
    src: mlinux-firmware-upgrade
    force: false
    mode: "0755"
    owner: root
    group: root

- name: mlinux-upgrade | Do flash upgrade and reboot
  ansible.builtin.reboot:
    reboot_command: "/usr/sbin/mlinux-firmware-upgrade {{ mlinux_upgrade_bin }}_{{ mlinux_version }}"
    post_reboot_delay: 30
    test_command: "test -f {{ mlinux_restore_init_crumb }}"

#
# Recover state
#

- name: mlinux-upgrade | Run mlinux_setup script
  ansible.builtin.import_tasks: mlinux_setup.yml

# XXX - Change root password

- name: mlinux-upgrade | Reload ansible_local
  ansible.builtin.setup:
    filter: ansible_local

- name: mlinux-upgrade | Fail if upgrade did not take
  ansible.builtin.fail:
    msg: "mlinux-firmware-upgrade did not work. Expected {{mlinux_version }}, got {{ ansible_local.mlinux.version }}"
  when: "'mlinux' not in ansible_local or mlinux_version != ansible_local.mlinux.version"
...
