---

#
#	Ansible first pass setup
#
- name: Install Ansible dependency python-distutils
  opkg: 
    state: installed
    pkg: "python-distutils"
  when:
    - ansible_local is defined
    - ansible_local.opkg is defined
    - ansible_local.opkg.python_distutils is not defined
  tags: setup

- name: Install Ansible dependency python-pkgutil
  opkg: 
    state: installed
    pkg: "python-pkgutil"
  when:
    - ansible_local is defined
    - ansible_local.opkg is defined
    - ansible_local.opkg.python_pkgutil is not defined
  tags: setup

- name: /var/config/ansible
  file:
    name: /var/config/ansible
    state: directory
    mode: "0755"
    owner: root
    group: root
  tags: setup

- name: /var/config/ansible/facts.d
  copy:
    dest: "/var/config/ansible/"
    mode: "0755"
    directory_mode: "0755"
    owner: root
    group: root
    src: facts.d
  register: ansible_facts_d
  tags: setup

- name: Point /etc/ansible at /var/config/ansible
  file:
    name: /etc/ansible
    state: link
    src: /var/config/ansible
  register: var_config_ansible
  tags: setup

- name: Reload ansible_local
  setup: filter=ansible_local
  when: ansible_facts_d|changed or var_config_ansible|changed
  tags: setup

- name: Upgrade mlinux
  import_tasks: mlinux.yml
  when:
    - mlinux_version is defined
    - mlinux_version != ansible_local.mlinux.version
  tags: setup
  
#
#	Set up networking
#
- name: Setup networking
  import_tasks: networking.yml
  tags:
    - networking
    - setup

#
#	Set hostname
#
- name: Set /etc/hostname
  copy:
    dest: /etc/hostname
    content: "{{ hostname }}"
    mode: "0644"
    owner: root
    group: root
  tags:
    - hostname
    - setup
  notify: Set hostname

#
#	Set timezone and time
#
- name: Setup time
  import_tasks: time.yml
  tags:
    - time
    - setup

#
#	Set up user stuff
#
- name: Set up users
  import_tasks: users.yml
  tags:
    - users
    - setup

#
#	Secure ssh
#
- name: Set up ssh
  import_tasks: sshd.yml
  tags:
    - sshd
    - setup
  
#
#	Stop any services we don't want
#

- name: Stop mosquitto
  service: name=mosquitto state=stopped
  when: ansible_local.opkg.mosquitto is defined

  ignore_errors: true

- name: Disable mosquitto
  lineinfile: dest=/etc/default/mosquitto
    regexp="^ENABLED="
    line="ENABLED="no""
    state=present
  when: ansible_local.opkg.mosquitto is defined
  tags:
    - services
    - setup

#
#	Set up /usr/local tree
#
- name: Set up /usr/local tree
  import_tasks: local.yml
  tags:
    - localtree
    - setup

#
#	Install and configure TTN packet forwarder
#
- name: Set up TTN packet forwarder
  import_tasks: ttn.yml
  tags:
    - ttn

#
#	Install additional ca-certificates
#

- name: Additional Certificates
  import_tasks: certs.yml
  tags:
    - ca-certificates
    - setup

#
#	Set up ssh_tunnel (autossh)
#
- name: Set up ssh_tunnel (autossh)
  import_tasks: ssh_tunnel.yml
  tags:
    - ssh_tunnel
    - setup

