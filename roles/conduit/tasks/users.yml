---

#
# Setup users
#

- name: users | Create non-volatile home dirs
  ansible.builtin.file:
    dest: /var/config/home
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: users | "Set up dirs for root"
  ansible.builtin.import_tasks: user_dirs.yml
  vars:
    target_user: "root"

#
# Create ttn user
#
- name: users | "Set up {{ ttn_user }} user"
  ansible.builtin.user:
    name: "{{ ttn_user }}"
    append: true
    groups: adm,dialout,disk,plugdev,sudo
    shell: /bin/bash
    password: "*"

- name: users | Configure mtadm user
  vars:
    target_user: ttn
  block:
    - name: users | ttn dirs
      ansible.builtin.import_tasks: user_dirs.yml
    - name: users | ttn sudo
      ansible.builtin.import_tasks: user_sudo.yml

#
# Configure mtadm user
#

- name: users | Configure mtadm user
  when:
    - ansible_local.mlinux.version is version('4', '>=')
  vars:
    target_user: mtadm
  block:
    - name: users | mtadm dirs
      ansible.builtin.import_tasks: user_dirs.yml
    - name: users | mtadm sudo
      ansible.builtin.import_tasks: user_sudo.yml
    - name: users | Disable pam auth functions
      ansible.builtin.lineinfile:
        dest: /etc/pam.d/sshd
        regex: ^(auth .*)$
        line: '# \1'
        backrefs: true
