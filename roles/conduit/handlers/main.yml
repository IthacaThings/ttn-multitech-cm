---
# handlers file for setup

#
# Make sure init script is run
#
- name: Update rc
  ansible.builtin.shell: "for init in ttn-pkt-forwarder lora-basic-station; do update-rc.d -f ${init} remove; test -f /etc/init.d/${init} && update-rc.d ${init} defaults 95 30 || true; done"

#
# Restart the packet forwarder
#
- name: Restart ttn-pkt-forwarder
  ansible.builtin.service:
    name: ttn-pkt-forwarder
    state: restarted
    sleep: "{{ forwarder_restart_delay }}"

#
# Restart the LoRA basic Station
#
- name: Restart lora-basic-station
  ansible.builtin.service:
    name: lora-basic-station
    state: restarted
    sleep: "{{ forwarder_restart_delay }}"

#
# Clean up after TTNv3 install
#
- name: TTNv3 cleanup
  ansible.builtin.include_tasks: ttnv3_cleanup.yml

#
#       Restart ntpd
#
- name: Restart ntpd
  ansible.builtin.service:
    name: ntpd
    state: restarted

#
#       Restart ssh_tunnel
#
- name: Restart ssh_tunnel
  ansible.builtin.include_tasks: restart_tunnel.yml

#
# Restart sshd after config changes
#
- name: Restart ssh
  ansible.builtin.service: # noqa: ignore-errors
    name: sshd
    state: restarted
  async: 1
  ignore_errors: true

#
# Remind
#
- name: Interface reboot
  ansible.builtin.debug:
    msg: Interface configuration changed, remember to reboot

#
# Reload the facts
#
- name: Reload facts
  ansible.builtin.include_tasks: reload_facts.yml

#
# ppp
#
- name: Start ppp
  ansible.builtin.service:
    name: ppp
    enabled: true
    state: restarted

- name: Stop ppp
  ansible.builtin.service:
    name: pppd
    enabled: false
    state: stopped

#
# opkg handlers
#
- name: Opkg clean
  ansible.builtin.command: "opkg clean --autoremove"
  when: ansible_local.mlinux.version is version('5', '>=')

- name: Opkg update
  ansible.builtin.command: "opkg update"
  register: result
  when: mlinux_feed is changed or ttni_feed is changed
  until: result is succeeded
  retries: 10
  delay: 10
  notify: Reload facts

#
# Monit handlers
#
- name: Restart monit
  ansible.builtin.service:
    name: monit
    state: restarted

- name: Monit monitor check_pktfwdlog
  ansible.builtin.command: "monit monitor check_pktfwdlog" # noqa: ignore-errors
  ignore_errors: true

- name: Monit monitor volatile
  ansible.builtin.command: "monit monitor volatile" # noqa: ignore-errors
  ignore_errors: true

- name: Update system checksum file
  ansible.builtin.include_tasks: update_checksums.yml
