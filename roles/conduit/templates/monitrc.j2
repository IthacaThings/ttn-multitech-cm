# AUTOMATICALLY GENERATED BY ANSIBLE, EDITS WILL BE LOST

# Log to syslog
set logfile syslog facility log_daemon

# Poll every 5 seconds
set daemon 5

# Use a Unix socket for monitoring
set httpd unixsocket /var/run/monit.sock
    allow monit:monit

# Monitor the system
check system ${HOST}

#
#	Monitor networking
#

# Monitor a host for network reachability
{% if monit_ping_host is defined %}
ping host monit_ping_host address {% monit_ping_host %}
  if failed ping
{% if monit_ping_count is defined %}
      count {% monit_ping_count %}
{% endif %}
{% if monit_ping_timeout is defined %}
      timeout {% monit_ping_timeout %}
{% endif %}
  then
    exec "/sbin/reboot"
{% endif %}

# XXX - Monitor /var/config and /etc for changes?

# XXX - Monitor space on flash F/S from Terry's scripts

#
#	Monitor services
#

# Monitor ttn-pkt-forwarder
check process ttn-pkt-forwader PIDFILE /var/run/lora-pkt-fwd.pid
   start program = "/etc/init.d/ttn-pkt-forwarder start" with timeout 15 seconds
   stop program = "/etc/init.d/ttn-pkt-forwarder stop"

# Check for error conditions in packet forwarder log
check file lora-pkt-fwd.log with path /var/log/lora-pkt-fwd.log
   if content = "XXXX" then exec "/etc/init.d/ttn-pkg/forwarder restart"

{% if ssh_tunnel_enabled %}
# Monitor autossh
check process ssh_tunnel PIDFILE /var/run/ssh_tunnel.pid
    start program = "/etc/init.d/ssh_tunnel start" with timeout 15 seconds
    stop program = "/etc/init.d/ssh_tunnel stop"
{% endif %}

# Monitor sshd
check process sshd PIDFILE /var/run/sshd.pid
    start program = "/etc/init.d/sshd start" with timeout 15 seconds
    stop program = "/etc/init.d/sshd stop"

# Monitor ntpd
check process ntpd PIDFILE /var/run/ntp.pid
    start program = "/etc/init.d/ntpd start" with timeout 15 seconds
    stop program = "/etc/init.d/ntpd stop"
